# App Obras Backend

## Overview
This is the backend repository for the **App Obras** project at **Krystaline**. It provides a robust API for managing work orders (Partes), offers (Ofertas), labor (Mano de Obra), and worker management.

The application is built with **FastAPI** and interacts with a SQL database using **PyODBC**.

## Features
- **Work Order Management (Partes)**: Create, update, and retrieve work orders.
- **PDF Generation**: Automatically generate PDF reports for work orders using templates.
- **Offers & Lines (Ofertas)**: Manage project offers and associated line items.
- **Labor Management (Mano de Obra)**: Track labor hours and assignments.
- **Worker Management**: Manage worker details and assignments.
- **Media Support**: Handle image uploads and associations.

## Tech Stack
- **Language**: Python 3.9+
- **Framework**: [FastAPI](https://fastapi.tiangolo.com/)
- **Database Driver**: [pyodbc](https://github.com/mkleehammer/pyodbc)
- **PDF Processing**: `pymupdf` (likely used for PDF filling/manipulation)
- **Server**: Uvicorn

## Prerequisites
- Python 3.9 or higher.
- ODBC Driver for SQL Server (e.g., ODBC Driver 17/18 for SQL Server) installed on the system.
- Access to the target SQL database.

## Installation

1. **Clone the repository**
   ```bash
   git clone <repository_url>
   cd app-obras-backend
   ```

2. **Create and activate a virtual environment**
   ```bash
   # Windows
   python -m venv .venv
   .venv\Scripts\activate

   # Linux/MacOS
   python3 -m venv .venv
   source .venv/bin/activate
   ```

3. **Install dependencies**
   ```bash
   pip install -r requirements.txt
   ```

4. **Environment Configuration**
   Create a `.env` file in the root directory. You can copy the structure from a provided example or ensure it contains the necessary database credentials:
   ```env
   # Example variables (adjust based on actual usage)
   DB_SERVER=your_server_address
   DB_NAME=your_database_name
   DB_USER=your_username
   DB_PASSWORD=your_password
   ```

## Running the Application

Start the development server with:

```bash
python main.py
```
Or directly via `uvicorn`:
```bash
uvicorn main:app --host 0.0.0.0 --port 8082 --reload
```

The application will be available at imports `http://localhost:8082`.

## API Documentation
Interactive API documentation is automatically generated by FastAPI and available at:
- **Swagger UI**: [http://localhost:8082/docs](http://localhost:8082/docs)
- **ReDoc**: [http://localhost:8082/redoc](http://localhost:8082/redoc)

## Project Structure
```
app-obras-backend/
├── db/                 # Database connection and queries
├── dependencies.py     # API dependencies (e.g., authentication)
├── dto/                # Data Transfer Objects (Pydantic models)
├── entities/           # Database entity definitions
├── routers/            # API Route handlers (endpoints)
│   ├── partes.py       # Work order endpoints
│   ├── ofertas.py      # Offer endpoints
│   ├── workers.py      # Worker endpoints
│   └── ...
├── utils/              # Utility functions
├── main.py             # Application entry point
└── requirements.txt    # Project dependencies
```

## Authentication
The API uses header-based authentication. Requests must valid `User` and `Authorization` headers:
- `User`: The ID of the user.
- `Authorization`: `Bearer <token>`

## License
Internal use only - Krystaline.
